name: Build Android APK

on:
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘æ„å»º
  push:
    branches: [ main ]

jobs:
  build-apk:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Java 11
      uses: actions/setup-java@v3
      with:
        distribution: 'temurin'
        java-version: '11'

    - name: Setup Android SDK
      uses: android-actions/setup-android@v2

    - name: Install Cordova
      run: npm install -g cordova@11.0.0

    - name: Create Cordova project
      run: |
        cordova create cordova-app com.demius.accounting "Accounting App"
        cd cordova-app
        cordova platform add android@10.1.2

    - name: Copy web assets
      run: |
        # å¤åˆ¶webæ–‡ä»¶åˆ°Cordovaé¡¹ç›®
        cp index.html cordova-app/www/
        mkdir -p cordova-app/www/src
        cp -r src/* cordova-app/www/src/
        
        # åˆ›å»ºå¿…è¦çš„Cordovaé…ç½®æ–‡ä»¶
        echo '<?xml version="1.0" encoding="UTF-8"?>
<widget id="com.demius.accounting" version="1.0.0" xmlns="http://www.w3.org/ns/widgets">
    <name>Accounting App</name>
    <description>Personal Accounting Application</description>
    <author email="demius@qq.com" href="https://github.com/demius782">Demius</author>
    <content src="index.html" />
    <access origin="*" />
    <allow-intent href="http://*/*" />
    <allow-intent href="https://*/*" />
    <platform name="android">
        <preference name="android-minSdkVersion" value="22" />
        <preference name="android-targetSdkVersion" value="33" />
    </platform>
</widget>' > cordova-app/config.xml

    - name: Build APK
      run: |
        cd cordova-app
        cordova build android --release

    - name: Upload APK artifact
      uses: actions/upload-artifact@v4
      with:
        name: accounting-app-apk
        path: cordova-app/platforms/android/app/build/outputs/apk/release/*.apk

    - name: Show APK info
      run: |
        echo "âœ… APKæ„å»ºå®Œæˆ!"
        echo "ğŸ“¦ APKæ–‡ä»¶è·¯å¾„: cordova-app/platforms/android/app/build/outputs/apk/release/"
        find cordova-app/platforms/android/app/build/outputs/apk/release/ -name "*.apk"