name: Build Android APK

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  build-apk:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Java 11
      uses: actions/setup-java@v3
      with:
        distribution: 'temurin'
        java-version: '11'

    - name: Setup Android SDK
      uses: android-actions/setup-android@v2

    - name: Install Cordova
      run: npm install -g cordova@11.0.0

    - name: Create Cordova project
      run: |
        cordova create cordova-app com.demius.accounting "Accounting App"
        cd cordova-app
        cordova platform add android@10.1.2

    - name: Copy web assets
      run: |
        cp index.html cordova-app/www/
        mkdir -p cordova-app/www/src
        cp -r src/* cordova-app/www/src/
        
        # 创建config.xml文件
        echo '<?xml version="1.0" encoding="UTF-8"?>' > cordova-app/config.xml
        echo '<widget id="com.demius.accounting" version="1.0.0" xmlns="http://www.w3.org/ns/widgets">' >> cordova-app/config.xml
        echo '    <name>Accounting App</name>' >> cordova-app/config.xml
        echo '    <description>Personal Accounting Application</description>' >> cordova-app/config.xml
        echo '    <author email="demius@qq.com" href="https://github.com/demius782">Demius</author>' >> cordova-app/config.xml
        echo '    <content src="index.html" />' >> cordova-app/config.xml
        echo '    <access origin="*" />' >> cordova-app/config.xml
        echo '    <allow-intent href="http://*/*" />' >> cordova-app/config.xml
        echo '    <allow-intent href="https://*/*" />' >> cordova-app/config.xml
        echo '    <platform name="android">' >> cordova-app/config.xml
        echo '        <preference name="android-minSdkVersion" value="22" />' >> cordova-app/config.xml
        echo '        <preference name="android-targetSdkVersion" value="33" />' >> cordova-app/config.xml
        echo '    </platform>' >> cordova-app/config.xml
        echo '</widget>' >> cordova-app/config.xml

    - name: Build APK
      run: |
        cd cordova-app
        cordova build android --release

    - name: Upload APK artifact
      uses: actions/upload-artifact@v4
      with:
        name: accounting-app-apk
        path: cordova-app/platforms/android/app/build/outputs/apk/release/*.apk

    - name: Show APK info
      run: |
        echo "✅ APK构建完成!"
        find cordova-app/platforms/android/app/build/outputs/apk/release/ -name "*.apk"